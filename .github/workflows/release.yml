name: Release (npm publish)

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write
  id-token: write

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: "pnpm"

      - name: Install
        run: pnpm install --frozen-lockfile

      - name: Lint
        run: pnpm run lint

      - name: Test
        run: pnpm run test

      - name: Build
        run: pnpm run build

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true

      - name: Debug OIDC availability
        run: |
          echo "ACTIONS_ID_TOKEN_REQUEST_URL=${ACTIONS_ID_TOKEN_REQUEST_URL:+SET}"
          echo "ACTIONS_ID_TOKEN_REQUEST_TOKEN=${ACTIONS_ID_TOKEN_REQUEST_TOKEN:+SET}"

      - name: Fetch OIDC token (length only)
        run: |
          set -euo pipefail
          URL="$ACTIONS_ID_TOKEN_REQUEST_URL&audience=npm"
          RESP="$(curl -sSf -H "Authorization: Bearer $ACTIONS_ID_TOKEN_REQUEST_TOKEN" "$URL")"
          LEN="$(node -e "const t=JSON.parse(process.argv[1]).value; console.log(t.length)" "$RESP")"
          echo "OIDC token length: $LEN"

      - name: Upgrade npm
        run: |
          npm -v
          npm i -g npm@latest
          npm -v
    
    

      - name: Publish (Trusted Publishing)
        run: npm publish --provenance --access public --registry=https://registry.npmjs.org/
